#include <ansi.h>

inherit SSERVER;

int perform(object me, object target)
{
	string msg;
	int extra;
	int damage;
	int cd = 6;
	if( !target ) target = offensive_target(me);

	if( !target
	||	!target->is_character()
	||	!me->is_fighting(target) )
                return notify_fail("超生渡化只能对战斗中的对手使用。\n");
	
	if( me->query("lunhui_zhuanshi") > 3 )
		cd = 5;
	if ( time() - me->query_temp("lastchaodu") < cd )
	  return notify_fail("你刚刚使过超渡绝招，还是歇会儿吧。\n");
	if((int)me->query_skill("lunhui-zhang", 1) < 50)
 		return notify_fail("你的轮回杖修为还不够，使用这一招会有困难！\n");
//      if (!(me->query("id")=="bell" || "xiaoxiao"))
//       return notify_fail("只有风铃才可以使超度绝招.\n");
	if(!wizardp(me) && me->query("family/family_name")!="南海普陀山")
                return notify_fail("不是佛门弟子不能用「慈光普渡」！\n");
	if (me->query("force")<500)
	 	return notify_fail("你的内力不够。\n");
        extra = me->query_skill("lunhui-staff",1)/2;
	me->add_temp("apply/attack", extra*3);	
	me->add_temp("apply/damage", extra);
	target->add_temp("apply/dodge",-extra);
	target->add_temp("apply/parry",-extra);
  	msg = HIR "$N缓缓说道：佛曰，以杀止杀！\n" NOR;
	message_vision(msg, me, target);
	COMBAT_D->do_attack(me,target, me->query_temp("weapon"));
  	msg =  HIW "天理循环，报应不爽！\n"NOR;
        message_vision(msg, me, target);
	COMBAT_D->do_attack(me,target, me->query_temp("weapon"));
  	msg =  HIC "天网恢恢，疏而不漏！\n"NOR;
        message_vision(msg, me, target);
        COMBAT_D->do_attack(me,target, me->query_temp("weapon"));
  	msg =  HIG "放下屠刀，立地成佛！\n"NOR;
        message_vision(msg, me, target);
        COMBAT_D->do_attack(me,target, me->query_temp("weapon"));
 	msg =  HIY "$N周身大放光明，佛口开合：孽障，到如今还不皈依？！\n"NOR;
	message_vision(msg, me, target);
	if( random(me->query_skill("buddhism",1)) > random(target->query_skill("spells",1)/4) )
	{
		message_vision(HIR "\n$n被$N的佛法感化，跪倒在地已经忘记了自己还在战斗之中！\n\n" NOR, me,target);
		damage = me->query_skill("spells");
		damage = damage + random(damage/3);
		target->receive_damage("sen",damage,me);
		target->receive_wound("sen",damage,me);
		COMBAT_D->report_sen_status(target);	
	}
	else
		message_vision(HIC "\n$n大叫到：我命由天，不由你！\n\n" NOR, me,target);
	me->add_temp("apply/attack", -extra*3);
	me->add_temp("apply/damage", -extra);
	target->add_temp("apply/dodge",extra);
        target->add_temp("apply/parry",extra);
	me->set_temp("lastchaodu",time());
	//me->start_busy(2);
	return 1;
}
